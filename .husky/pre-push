DEBUG=1

log_debug() {
  if [ "$DEBUG" -eq 1 ]; then
    echo "[DEBUG] $1"
  fi
}

branch=$(git rev-parse --abbrev-ref HEAD)
log_debug "Current branch: $branch"

# Skip merge check if pushing main itself
if [ "$branch" = "main" ]; then
  log_debug "Skipping merge check: pushing from 'main'"
  exit 0
fi

# Collect all protected branches (main + remote */main)
protected_branches="main"

tmpfile=$(mktemp)
git for-each-ref --format='%(refname)' refs/remotes/*/main > "$tmpfile"

while IFS= read -r ref; do
  branch_name=$(echo "$ref" | sed 's|refs/remotes/||')
  protected_branches="$protected_branches
$branch_name"
  log_debug "Found remote branch: $branch_name"
done < "$tmpfile"

rm "$tmpfile"

# Determine the commit range for this push
upstream_branch=$(git for-each-ref --format='%(upstream:short)' "refs/heads/$branch")
if [ -n "$upstream_branch" ]; then
  commit_range="$upstream_branch..HEAD"
  log_debug "Using upstream range: $commit_range"
else
  commit_range="HEAD"
  log_debug "No upstream found. Checking all commits in HEAD."
fi

merge_commits=$(git log "$commit_range" --merges --pretty=%H)

log_debug "Merge commits in range:"
for commit in $merge_commits; do
  log_debug "  - $commit"
done

# Check merge commits for protected parent history
for commit in $merge_commits; do
  parents=$(git log -1 --pretty=%P "$commit")
  log_debug "Inspecting merge commit $commit (parents: $parents)"

  for parent in $parents; do
    echo "$protected_branches" | while IFS= read -r protected; do
      if git merge-base --is-ancestor "$protected" "$parent"; then
        echo "ðŸš« Push rejected: Merge from '$protected' detected in branch '$branch'."
        echo "ðŸ’¡ Please rebase instead: git rebase $protected"
        exit 1
      fi
    done
  done
done

log_debug "âœ… No forbidden merges detected. Push allowed."
exit 0
